WITH negative_inv_facts AS (
SELECT
    SRC.MEAS_DT         AS MEAS_DT,
    SRC.ITEM_KEY        AS ITEM_KEY,
    SRC.LOCATION_KEY    AS LOCATION_KEY,
    -SRC.F_FACT_QTY     AS F_FACT_QTY,
    -SRC.F_FACT_CST     AS F_FACT_CST,
    -SRC.F_FACT_RTL     AS F_FACT_RTL
FROM DBT_POC_DB.DBT_DATA_MART.TGT_INV_MEAS_FACT_ILD SRC
INNER JOIN {{ref('tmp_inv_ild_b')}} DELTA
    ON SRC.LOCATION_KEY = DELTA.LOCATION_KEY
    AND SRC.ITEM_KEY = DELTA.ITEM_KEY
WHERE 1 = 1
AND SRC.MEAS_DT BETWEEN 
    (SELECT DISTINCT MTH_START_DT FROM dbt_poc_db.dbt_poc_tgt.dwh_D_CURR_TIM_LU) 
    AND 
    (SELECT MAX(DAY_KEY) FROM {{ref('tmp_inv_ild_b')}})
),
positive_inv_facts as (
SELECT
    TIM.DAY_KEY AS MEAS_DT,
    SRC.ITEM_KEY AS ITEM_KEY,
    SRC.LOCATION_KEY AS LOCATION_KEY,
    SRC.F_OH_QTY AS F_FACT_QTY,
    SRC.F_OH_CST AS F_FACT_CST,
    SRC.F_OH_RTL AS F_FACT_RTL
FROM DBT_POC_DB.DBT_POC_TGT.TGT_INV_IL_B SRC
INNER JOIN DBT_POC_DB.DBT_POC_TGT.TGT_LOCATION LOC ON LOC.LOCATION_KEY = SRC.LOCATION_KEY
INNER JOIN DBT_POC_DB.DBT_POC_TGT.TGT_PRODUCT ITM ON SRC.ITEM_KEY = ITM.ITEM_KEY
CROSS JOIN (SELECT MAX(DAY_KEY) as day_key FROM dbt_poc_db.dbt_poc_tgt.tgt_inv_ild_b) TIM
)
SELECT * FROM negative_inv_facts 
UNION 
SELECT * FROM positive_inv_facts
